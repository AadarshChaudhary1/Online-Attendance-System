<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container mt-5">
    <h2>View Class Reports</h2>
    <p>Select one of your assigned classes to view the attendance report.</p>
    <a href="{{ url_for('teacher.teacher_dashboard') }}" class="btn btn-secondary mb-3">Back to Dashboard</a>
    <hr>

   
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} mt-2">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}


    <form method="POST" class="row g-3 mb-4 p-3 border rounded bg-white shadow-sm">
        <div class="col-md-8">
            <label class="form-label">Select Class/Subject</label>
            <select name="alloc_id" class="form-select" required>
                <option value="">-- Select class to view report --</option>
                {% for subject in teacher_subjects %}
                <option value="{{ subject.alloc_id }}" {% if selected_alloc_id == subject.alloc_id|string %}selected{% endif %}>
                    {{ subject.year }} - {{ subject.section }} ({{ subject.subject_code }}: {{ subject.subject_name }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4 align-self-end">
            <button type="submit" class="btn btn-primary w-100">View Report</button>
        </div>
    </form>

    {% if reports %}
    <h3 class="mt-4">
        Report: {{ selected_allocation.year }} - {{ selected_allocation.section }}
        <small class="text-muted">({{ selected_allocation.subject_code }})</small>
    </h3>
    <div class="alert alert-info">
        <strong>Total Classes Held: {{ total_classes }}</strong>
    </div>

  
    <div class="mb-3 d-flex gap-2">
        <form method="POST" action="{{ url_for('teacher.download_class_report', file_type='csv') }}">
            <input type="hidden" name="alloc_id" value="{{ selected_alloc_id }}">
            <button type="submit" class="btn btn-success">⬇️ Download CSV</button>
        </form>
        <form method="POST" action="{{ url_for('teacher.download_class_report', file_type='pdf') }}">
            <input type="hidden" name="alloc_id" value="{{ selected_alloc_id }}">
            <button type="submit" class="btn btn-danger">⬇️ Download PDF</button>
        </form>
    </div>


    <table class="table table-bordered table-striped table-hover bg-white shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>MIS Number</th>
                <th>Name</th>
                <th>Classes Attended</th>
                <th>Total Classes</th>
                <th>Attendance %</th>
            </tr>
        </thead>
        <tbody>
            {% for mis_no, name, attended, total, percent in reports %}
            <tr class{% if percent < 75 %}"table-danger"{% elif percent < 90 %}"table-warning"{% endif %}>
                <td>{{ mis_no }}</td>
                <td>{{ name }}</td>
                <td>{{ attended }}</td>
                <td>{{ total }}</td>
                <td>{{ percent }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% elif selected_alloc_id %}
       
        <div class="alert alert-warning text-center">
            No reports found for this selection.
        </div>
    {% endif %}

</div>
</body>
</html>